<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Website</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">
    <style>/*------ switch toggle ------*/ .switch {   position: relative;   display: inline-block;   width: 40px;   height: 20px; } .switch input {   opacity: 0;   width: 0;   height: 0; } .slider {   position: absolute;   cursor: pointer;   top: 0;   left: 0;   right: 0;   bottom: 0;   background-color: #ccc;   -webkit-transition: .4s;   transition: .4s; } .slider:before {     position: absolute;     content: "";     left: 5%;     bottom: 5%;     background-color: white;     -webkit-transition: .4s;     transition: .4s;     height: 90%;     aspect-ratio: 1/1; } input:checked + .slider {   background-color: #8484c2; } input:focus + .slider {   box-shadow: 0 0 1px #8484c2; } input:checked + .slider:before {   -webkit-transform: translateX(100%);   -ms-transform: translateX(100%);   transform: translateX(100%); } .slider.round {   border-radius: 9999px; } .slider.round:before {   border-radius: 50%; }</style>
    <style>/*------ wrappers ------*/ .horizontal-block { display: flex; width: fit-content; align-items: center; } .vertical-block { display: flex; justify-items: center; flex-direction: column; }</style>
    <script>async function Post(url, data) { try { url = "https://backend.zhmikh.ru" + url; const response = await fetch(url, {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}); if (!response.ok) throw new Error(`Ошибка: ${response.status}`); const result = await response.json(); return result;} catch (error) {console.error('Произошла ошибка при отправке запроса:', error); throw error;}}</script>
    <script>async function Get(url) { try { url = "https://backend.zhmikh.ru" + url; const response = await fetch(url); if (!response.ok) throw new Error(`Ошибка: ${response.status}`); const result = await response.json(); return result;} catch (error) {console.error("Произошла ошибка при выполнении GET-запроса:", error); throw error;}}</script>
    <!-- name-input resize --><script>function resize() { const element = document.querySelector('#name-input'); const maxWidth = parseInt(document.querySelector("#message-area").clientWidth); let attempts = 0; if (element.scrollWidth >= maxWidth - 10 && attempts++ < 30) { element.value = element.value.slice(0, -1) }; element.style.width = "0px"; element.style.width = `${element.scrollWidth}px`;}</script>
    <style>/*------ for main1 ------*/
      #name-input, #message-area {
        min-height: 24px; 
        font-size: 16px;
        border: none;
      }

      #name-input:focus, #message-area:focus {
        outline: none;
      }

      .sign {
        position: absolute;
        bottom: 5px;
        right: 5px;
        cursor: pointer;
      }

      .message-input {
        border: 1px solid #7d7a7a;
        border-radius: 10px;
        overflow: hidden;
        max-width: 94vw;
        display: flex;
        width: 100%;
        height: 40vh;
        padding-bottom: 24px;
      }

      .message-input.focus {
        border-color: #333; 
      }

      .message-input.no-sign { padding-bottom: 0px; }
      
      #message-area {
        resize: none; 
        width: 100%;
        height: 100%;
        padding: 10px;
      }

      .send-btn {
        border: none;
        background-color: #7d7dbf;
        border-radius: 5px;
        padding: 7px;
        min-width: 45px;
        font-size: 16px;
        position: absolute;
        right: 1px;
        margin-right: 3vw;
        margin-top: -7px;
      }
    </style>
    <style>/*------ for main2 ------*/
    </style>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        position: relative;
      }

      .hidden { display: none; }

      main {
        width: 75vw;
        height: 50vh;
        background: white;
        box-shadow: 0px 5px 10px 2px rgba(34, 60, 80, 0.2);
        border-radius: 15px;
        overflow: hidden;
        position: absolute;
        top: 25vh;
        left: 12.5vw;
        opacity: 0.95;
      }
    </style>
  </head>
  <body>
    <center><h1>Hello, put your message here:</h1></center>
<!--      -->
    <main>
      <main1 class="hidden">
        <form class="vertical-block" style="margin: 10px;min-width: 50px;">
          <div class="horizontal-block" style="gap: 5px">
            <h5 style="font-size: 14px;">stay anonimus</h5>
            <label class="switch" style="width: 28px; height: 14px;">
              <input id="anonimus" type="checkbox" checked onchange="document.querySelector('#name-input').parentElement.classList.toggle('hidden');document.querySelector('.message-input').classList.toggle('no-sign');resize()">
              <span class="slider round"></span>
            </label>
          </div>
      
            <div class="message-input no-sign"><textarea onfocusout="this.parentElement.classList.remove('focus')" onfocus="this.parentElement.classList.add('focus')" id="message-area" style="width: 100%;" name="message-text"></textarea></div>
            <div class="horizontal-block hidden sign"><h6>~</h6><input style="width: 10px;" name="message-author" id="name-input" oninput="resize()" value="Name"></div>
        </form>
        <button class="send-btn" onclick="let author; if (document.querySelector('#anonimus').checked) { author = null } else { author = document.querySelector('#name-input').value };Post('/send', { 'text': document.querySelector('#message-area').value, 'author': author }).then(data => window.location.href = `/?id=${data.id}`)">send</button>
      </main1>
<!--        -->
      <main2 class="hidden">
        test
      </main2>
    </main>
    <!-- url check --><script>const c = new URLSearchParams(location.search).has('id') ? 2 : 1; document.querySelector(`main${c}`).classList.remove('hidden')</script>
    <script>
      const main = document.querySelector('main1').classList.contains('hidden')? document.querySelector('main2') : document.querySelector('main1');
      let minX, minY, maxX, maxY = 0;
      Get('/messages').then(data => { data.forEach((msg) => {
        try {
          if (minX > msg.pos[0]) minX = msg.pos[0];
          if (minY > msg.pos[1]) minY = msg.pos[1];
          if (maxX < msg.pos[0]) maxX = msg.pos[0];
          if (maxY < msg.pos[1]) maxY = msg.pos[1];
        } catch { console.log(`message has not positioned. id: ${msg.id}`) }

        document.body.style.width = `${minX + maxX}px`;
        document.body.style.height = `${minY + maxY}px`;
        main.style.left = `${minX}px`;
        main.style.top = `${minY}px`;
        main.scrollIntoView({'block': 'center', 'inline': 'center'});
      }); spawnMessages(data, {'x': minX, 'y': minY});}).catch(error => console.error(error))

      function spawnMessages(data, min) {
        data.forEach(msg => {
          const message = document.createElement('div');
          let classes;
          if (new URLSearchParams(location.search).has("id")) classes = (new URLSearchParams(location.search).id == msg.id && msg.pos[0] != null)? ['message', 'vertical-block', 'from-user'] : ['message', 'vertical-block'];
          message.classList.add(...classes)

          if (classes.includes('from-user')) addEventListeners(message);

          const text = document.createElement('span');
          text.classList.add('msg-text');
          text.textContent = msg.text;
          message.appendChild(text);

          if (msg.author) {
            const sign = document.createElement('span');
            sign.classList.add('msg-sign');
            sign.textContent = `~${msg.author}`;
            message.appendChild(sign);
          }

          const date = document.createElement('span');
          date.classList.add('msg-date');
          date.textContent = msg.date;
          message.appendChild(date)

          message.style.left = msg.pos[0] > 0? min.x + msg.pos[0] : msg.pos[0];
          message.style.top = msg.pos[1] > 0? min.y + msg.pos[1] : msg.pos[1];
          document.body.appendChild(message);
        })
      }

      function addEventListeners(element) {
        console.log(element)
      }
    </script>
  </body>
</html>
